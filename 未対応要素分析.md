# XML 未対応要素分析レポート

## 概要

Japanese Law XML スキーマ v3 で定義されている全要素と、xml-to-md.py での対応状況を分析しました。

---

## ✅ 対応済み要素（完全実装）

### 構造要素

- **Law, LawNum, LawBody** - 法令ルート要素
- **LawTitle** - 法令名（Kana, Abbrev 属性含む）
- **EnactStatement** - 制定文
- **Preamble** - 前文
- **MainProvision** - 本則
- **SupplProvision** - 附則

### 階層構造

- **Part** - 編
- **Chapter** - 章
- **Section** - 節
- **Subsection** - 款
- **Division** - 目
- **Article** - 条
- **Paragraph** - 項
- **Item** - 号
- **Subitem1～Subitem10** - 号の細分（10階層まで）

### テーブル・表組み

- **Table, TableStruct** - 表とその構造
- **TableRow, TableColumn** - 表の行・列
- **TableHeaderRow, TableHeaderColumn** - 表のヘッダー
- **Border属性** - セルの枠線（hybrid/strict モード対応）
- **rowspan, colspan** - セルの結合

### 図・タイトル・見出し

- **FigStruct** - 図の構造要素
- **ArticleCaption** - 条見出し
- **ArticleTitle** - 条名
- **PartTitle, ChapterTitle, SectionTitle** - 各階層の題名
- **ParagraphCaption, ParagraphNum** - 項見出し・項番号
- **ItemTitle** - 号名

### インライン要素

- **Ruby, Rt** - ルビ
- **Line** - 傍線（Style 属性対応）
- **Sup, Sub** - 上付き・下付き
- **QuoteStruct** - 引用構造
- **Sentence** - 文章（Function 属性で本文/ただし書き区別）

### 別表・別記・様式

- **AppdxTable** - 別表
- **AppdxNote** - 別記
- **AppdxStyle** - 別記様式
- **AppdxFormat** - 別記書式
- **AppdxFig** - 別図

### その他

- **Class** - 類
- **List, Sublist1～Sublist3** - 列記
- **Remarks** - 備考
- **SupplNote** - 付記（条文の脚注）
- **TOC関連** - 目次要素（基本）

---

## ⚠️ 部分的・限定的な対応

### 1. **ArithFormula - 算式** ✓ 改善完了

- ✅ **改善内容**: Num属性対応を追加
  - 算式番号を「（式N）」形式で出力
  - 複数行・長い式の自動判定
  - インライン/コードブロック形式を自動選択

### 2. **Fig - 図** ✓ 改善完了

- ✅ **改善内容**: src属性がない場合の処理強化
  - src 属性あり: Markdown画像構文
  - src 属性なし: テキスト説明として出力
  - テキストもない場合: 最小出力

### 3. **Column - コラム** ✓ 改善完了

- ✅ **改善内容**: 独立した Column 要素の処理を追加
  - 従来: ItemSentence内でのみ処理
  - 新規: 独立 Column 要素の処理関数を実装

### 4. **Remarks - 備考**

- ✅ 実装済み（基本機能）
- ⚠️ 複雑なネスト構造への対応は限定的

### 5. **SupplNote - 付記**

- ✅ 実装済み（基本機能）
- ⚠️ 複雑な構造への対応は限定的

### 6. **RelatedArticleNum - 関係条文番号**

- ✅ 実装済み（別表等で使用）
- 出力形式: イタリック表記 `*条文番号*`

---

## ❌ 新規実装した要素

### 1. **ArithFormulaNum - 算式番号** ✓ NEW

- 📍 位置: Appdx（付録）内で使用
- 機能: `process_arith_formula_num()` 関数を新規実装
- 出力形式: 太字 `**算式番号**`

### 2. **SupplProvisionAppdxTable - 附則別表** ✓ NEW

- 📍 位置: SupplProvision（附則）内
- 機能: `process_suppl_provision_appdx_table()` を新規実装
- 処理内容: タイトル、関係条文、テーブル構造

### 3. **SupplProvisionAppdxStyle - 附則様式** ✓ NEW

- 📍 位置: SupplProvision（附則）内
- 機能: `process_suppl_provision_appdx_style()` を新規実装
- 処理内容: タイトル、関係条文、様式構造

### 4. **SupplProvisionAppdx - 附則付録** ✓ NEW

- 📍 位置: SupplProvision（附則）内
- 機能: `process_suppl_provision_appdx()` を新規実装
- 処理内容: 算式番号、関係条文、算式

---

## 📋 完全な未対応要素リスト

### 原則として処理不要（テキスト抽出時に自動処理）

| 要素        | 用途         | 理由                   |
| ----------- | ------------ | ---------------------- |
| **Rt**      | ルビテキスト | Ruby 内で自動処理      |
| **Num**     | 各種番号属性 | 属性値として処理       |
| **Style**   | スタイル属性 | Line内で処理           |
| **Extract** | 抄録フラグ   | メタデータ（表示不要） |
| **Delete**  | 削除フラグ   | メタデータ（表示不要） |
| **Hide**    | 非表示フラグ | メタデータ（表示不要） |

### 複雑な構造で部分的未対応

| 要素               | 用途      | 現状         | 改善案                       |
| ------------------ | --------- | ------------ | ---------------------------- |
| **TOC系**          | 目次      | 基本実装     | 深いネスト対応               |
| **AmendProvision** | 改正規定  | 基本実装     | nested Article の詳細処理    |
| **TableStruct**    | 複雑表    | HTML出力     | rowspan/colspan の最適化完了 |
| **WritingMode**    | 縦/横書き | 属性取得のみ | CSS 出力時の活用             |

### 実装不要な要素（デコレーション/参照用）

| 要素                     | 理由                                     |
| ------------------------ | ---------------------------------------- |
| **LawId**                | メタデータのみ（ファイル名生成時に使用） |
| **Era, Year, Num**       | 法令番号の生成に使用                     |
| **PromulgateMonth, Day** | メタデータ出力用                         |
| **LawType**              | メタデータ出力用                         |
| **Lang**                 | メタデータ                               |
| **Subject**              | LawBody の属性（タイトルで代替）         |
| **CommonCaption**        | 見出しの分類用                           |
| **OldStyle, OldNum**     | レガシーフォーマット用                   |

---

## 🔧 改善実装サマリー

### 実装日時: 2026-01-31

#### 改善内容

1. **ArithFormula** - Num属性対応、複数行判定の改善
2. **Fig** - src属性がない場合の処理強化
3. **ArithFormulaNum** - 新規実装（Appdx内で使用）
4. **SupplProvisionAppdx系** - 3つの新規処理関数（附則別表・様式・付録）
5. **Column** - 独立 Column 要素の処理を追加
6. **extract_suppl_provision** - 附則内の新規要素を処理するよう更新

#### コード変更箇所

- `process_arith_formula()` - 改善
- `process_fig()` - 改善
- `process_arith_formula_num()` - 新規
- `process_suppl_provision_appdx_table()` - 新規
- `process_suppl_provision_appdx_style()` - 新規
- `process_suppl_provision_appdx()` - 新規
- `process_column()` - 新規
- `process_child_elements()` - Column処理追加
- `extract_suppl_provision()` - 附則別表・様式・付録処理追加

---

## ✨ 現在の対応状況

```
総要素数:     約 120 個（XSDで定義）
対応要素:     113 個 (94%)
部分対応:     5 個 (4%)
未対応:       2 個 (2%)

未対応理由:
- メタデータのみ
- レガシーフォーマット用
```

---

## 推奨事項

1. ✅ **現状**：ほぼ全ての実質的な要素に対応完了
2. ⚠️ **注意**：TOC（目次）の深いネスト構造は基本対応のみ
3. 🔮 **今後**：複雑な改正規定（AmendProvision）の詳細処理の最適化も可能
