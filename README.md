# 日本法令XML→Markdown変換ツール

日本の法令XMLデータを読みやすいMarkdown形式に変換するPythonツールです。e-Gov法令APIからの直接取得、またはローカルのXMLファイルからの変換に対応しています。

> 📌 **このプロジェクトについて**
>
> このツールは **AI生成によって作成されたソフトウェア** です。
> その点ご承知おき下さい。

---

## 目次

- [プロジェクト情報](#プロジェクト情報)
- [特徴](#特徴)
- [必要要件](#必要要件)
- [インストール](#インストール)
- [使用方法](#使用方法)
  - [対話モード](#対話モード)
  - [コマンドライン引数モード](#コマンドライン引数モード)
- [出力フォーマット](#出力フォーマット)
  - [テーブルの罫線（Border）について](#テーブルの罫線borderについて)
  - [表の罫線情報の最適化（トークン削減戦略）](#表の罫線情報の最適化トークン削減戦略)
- [設定ファイル](#設定ファイル)
- [トラブルシューティング](#トラブルシューティング)

---

## プロジェクト情報

### 開発方法

このプロジェクトは **ペアプログラミング** で開発されています：

- **プログラマー**: ユーザー（要件定義、設計、テスト）
- **AI アシスタント**: GitHub Copilot（実装、バグ修正、最適化）

### 開発工程

各機能の実装・改善では以下のプロセスで行われます：

1. **要件定義**: ユーザーが改善・追加要件を提示
2. **実装**: AI が複数の案を提案し、ユーザーが最適な実装を選択
3. **テスト**: ユーザーが動作確認し、問題があれば修正
4. **提出**: `git commit` で変更を記録（コミットメッセージに実装内容を記載）

### XML要素対応率

**カバー率: 約 98%**（117要素中115要素に対応）

詳細は [XML要素対応状況.md](XML要素対応状況.md) を参照してください。

---

## 特徴

✅ **e-Gov法令APIからの直接取得**

- 法令名を入力するだけで最新の法令データを自動取得・変換
- 過去の時点（asof指定）にも対応

✅ **多様な入力形式**

- APIから直接取得
- ローカルのXMLファイルから変換
- フォルダ内の複数XMLファイルを一括変換
- リストファイルによる一括処理

✅ **読みやすいMarkdown出力**

- 階層構造を見出しレベルで表現
- 表（テーブル）はHTMLテーブルで再現
- ルビ（ふりがな）をHTMLタグで表現
- 法令の構造（編・章・節・条・項・号）を明確に表現

✅ **CSSスタイル同梱**

- ダークモード対応のスタイルシート付属
- 視覚的に区別しやすい色分け

---

## 必要要件

- **Python**: 3.7以上
- **必須ライブラリ**: `requests`

---

## インストール

### 1. リポジトリのクローンまたはダウンロード

```bash
git clone <リポジトリURL>
cd xml-markdown
```

### 2. 必要なPythonライブラリのインストール

```bash
python -m pip install requests
```

---

## 使用方法

このツールには2つの使用モードがあります：

### 対話モード

引数なしでスクリプトを実行すると、対話形式で操作できます。

```bash
python xml-to-md.py
```

#### モード1: 法令名を入力して検索（APIを使用）

1. プロンプトから「1」を選択
2. 法令名を入力（例: `道路交通法`）
3. 適用時点を指定（省略可、最新版を取得）
4. `output_Markdown/` フォルダに変換されたMarkdownファイルが保存されます

**例:**

```
選択してください (1/2/3/0): 1
法令名を入力してください: 道路交通法
適用時点 (asof) を指定してください。
（例: 2026-01-31 / 空Enterで現在施行中のものを取得）: 2025-06-01
```

**モード1の特徴:**

- e-Gov法令APIから法令データを直接取得
- Markdownファイル内に含まれる画像を自動的にダウンロード＆埋め込み
- ファイル名に施行日が自動的に付与される（例: `道路交通法_20250601.md`）

---

#### モード2: XMLファイルのパス、またはフォルダを指定（ローカル）

1. プロンプトから「2」を選択
2. XMLファイルのパス、またはXMLファイルが入ったフォルダパスを入力
3. フォルダを指定した場合、内部のすべての `.xml` ファイルを一括変換

**例:**

```
選択してください (1/2/3/0): 2
XMLファイルのパス、またはフォルダパス: 道路交通法.xml
```

**⚠️ モード2の注意事項:**

- **画像は埋め込まれません**: 画像データはダウンロードされず、Markdownに含まれません
  - **理由**: ローカルXMLファイルには法令履歴IDが含まれていないため、画像APIを呼び出せません
  - **対策**: 画像が必要な場合は、モード1（API取得）を使用してください
- ファイル名に施行日が付与されないことがあります。(e-govから手動ダウンロードしたxmlファイルには施行日情報が含まれていないことがあります。)

#### モード3: 法令リスト(law_list.txt)から一括処理

1. プロンプトから「3」を選択
2. リストファイル名を入力（デフォルト: `law_list.txt`）
3. 適用時点を指定（省略可）
4. リストに記載された全法令を自動で取得・変換

**例:**

```
選択してください (1/2/3/0): 3
リストファイル名を入力 (Enterで 'law_list.txt'): [Enter]
適用時点 (asof) を指定してください。
（例: 2026-01-31 / 空Enterで最新版を取得）: [Enter]
```

**モード3の特徴:**

- 複数の法令を一度に処理可能
- リストファイルに含まれるすべての法令を**確認なしで自動上書き**
- 画像も自動的にダウンロード＆埋め込み
- バッチ処理や自動化に最適
- ⚠️ **既存ファイルは自動上書きされます**（確認なし）
- ⚠️ **重要**: リスト処理は本当に必要なもののみを指定してください

---

### コマンドライン引数モード

バッチ処理や自動化に便利なコマンドライン引数モードです。

#### 1. 単一法令の取得・変換

```bash
python xml-to-md.py --law 法令名 [--asof YYYY-MM-DD]
```

**例:**

```bash
# 最新版の道路交通法を取得
python xml-to-md.py --law 道路交通法

# 2025年6月1日時点の道路交通法を取得
python xml-to-md.py --law 道路交通法 --asof 2025-06-01
```

**特徴**: 既存ファイルがあれば上書き確認が行われます（対話的）

#### 2. リストファイルからの一括処理

```bash
python xml-to-md.py --list [リストファイル名] [--asof YYYY-MM-DD]
```

**例:**

```bash
# law_list.txtから一括処理（最新版）
python xml-to-md.py --list

# 指定したリストファイルから一括処理
python xml-to-md.py --list my_laws.txt

# 2025年1月1日時点で一括処理
python xml-to-md.py --list --asof 2025-01-01
```

**⚠️ 特徴**: 既存ファイルは**確認なしで自動上書き**されます（バッチ処理向け）

#### 3. ヘルプの表示

```bash
python xml-to-md.py --help
```

**出力例:**

```
usage: xml-to-md.py [-h] [--law LAW] [--list [LIST]] [--asof ASOF]

Japanese Law XML to Markdown Converter

options:
  -h, --help     show this help message and exit
  --law LAW      法令名を指定してAPIから取得・変換します (確認なしで上書き)
  --list [LIST]  法令リストファイルを指定して一括処理します (デフォルト: law_list.txt)
  --asof ASOF    --law または --list 使用時に適用する法令の時点(YYYY-MM-DD)
```

---

## 出力フォーマット

### ファイル名

変換されたMarkdownファイルは `output_Markdown/` フォルダに以下の形式で保存されます：

```
法令名_施行日.md
```

**例:**

- `道路交通法_20250601.md`
- `日本国憲法_19470503.md`

### Markdown構造

#### 見出しレベル

法令の階層構造は以下のように変換されます：

- **H1 (`#`)**: 法令名
- **H2 (`##`)**: 編（Part）
- **H3 (`###`)**: 章（Chapter）
- **H4 (`####`)**: 節（Section）
- **H5 (`#####`)**: 款（Subsection）・目（Division）
- **H6 (`######`)**: 条（Article）

#### 箇条書き

- **項（Paragraph）**: `- **第1項**`
- **号（Item）**: `  - **第1号**`
- **号の細分**: インデントを深くして表現

#### テーブル（表）

表項目はHTMLの `<table>` タグで再現されます：

```html
<table class="writing-mode-vertical">
  <thead>
    <tr>
      <th>欄名1</th>
      <th>欄名2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>データ1</td>
      <td>データ2</td>
    </tr>
  </tbody>
</table>
```

**対応する属性:**

- `rowspan`、`colspan`: セルの結合
- `BorderTop`、`BorderBottom`、`BorderLeft`、`BorderRight`: 枠線スタイル
- `Align`: 水平方向の配置
- `Valign`: 垂直方向の配置
- `WritingMode`: 縦書き/横書き

#### テーブルの罫線（Border）について

法令XMLの多くの表は、**見た目を優先する設計** となっており、論理的な構造（rowspan/colspan）ではなく、**罫線（Border属性）で視覚的に表現**されています。このツールは、このような表を正確に変換するため、Border属性をMarkdownのHTMLテーブルに以下のように組み込んでいます：

```html
<td style="border-bottom: none; border-right: 1px solid black">内容</td>
```

**特徴:**

- `border-top: 1px solid black` → 枠線あり（solid）
- `border-bottom: none` → 枠線なし（見た目の結合を表現）
- `border-left`, `border-right`: 左右の枠線も同様に制御

**ハイブリッドモード（デフォルト）:**

- 明示的な `rowspan` 属性がある場合はそれを優先使用
- ない場合、Border属性（特に `BorderBottom="none"`）から rowspan を自動推測
- コマンドライン: `--table-mode hybrid` （デフォルト）

**ストリクトモード:**

- Border属性を無視し、明示的な `rowspan` 属性のみ使用
- コマンドライン: `--table-mode strict`

**⚠️ LLMによる読み取りの難しさ:**

罫線で表現された表（見た目優先）は、**LLMが論理的な構造を正確に読み取ることが難しい**傾向があります。理由：

1. **複数の表現方法が混在**: セマンティックなrowspanと見た目のBorder属性が共存
2. **意図の曖昧性**: 罫線なしが「結合」を意味するのか「単なる視覚効果」なのかの区別が難しい
3. **HTMLの複雑さ**: 罫線のCSSスタイルが多数含まれ、読み取り対象の情報が分散

**推奨:**

- 表の内容を自動処理する場合、元のXML構造（rowspan属性）を参考にしてください
- LLMに表を読み込ませる際は、「表の構造は罫線で表現されている」という前提を明示してください

#### 表の罫線情報の最適化（トークン削減戦略）

出力するMarkdownのトークン削減を目的として、**罫線が全て単純な場合（全セルが solid border）** は、出力から罫線情報を削除する最適化機能を実装しています。

**実装の概要:**

1. **罫線検出関数 `_check_table_has_non_solid_border()`**
   - テーブル内のすべてのセルをスキャン
   - `BorderTop`、`BorderBottom`、`BorderLeft`、`BorderRight` 属性をチェック
   - `solid` 以外（`none`、`dotted`、`double` など）の値を検出

   ```python
   def _check_table_has_non_solid_border(table, header, body_rows):
       # ヘッダー、ボディセルのBorder属性をすべてチェック
       # → solid以外があれば True、全て solid なら False を返す
   ```

2. **セル属性制御フラグ `enable_border_style`**
   - `get_cell_attributes()` 関数で使用
   - `True` = 罫線スタイル情報を `style` 属性に含める（複雑な表）
   - `False` = 罫線スタイル情報を削除（単純な表）

**現在の実装状況:**

| 項目         | 状態      | 説明                                            |
| ------------ | --------- | ----------------------------------------------- |
| 罫線検出関数 | ✅ 実装済 | `_check_table_has_non_solid_border()` が定義    |
| 制御フラグ   | ✅ 実装済 | `enable_border_style` パラメータが定義          |
| 統合処理     | ✅ 実装済 | `render_table()` からのフラグ渡し、テスト済み |

**削減効果:**

- **単純な表（全て solid）**: style属性が完全削除 → **トークン削減 ≈ 20～40%**
- **複雑な表（solid以外あり）**: style属性を保持 → **構造情報を保護**

**出力例:**

```html
<!-- 削減前：全セルが solid border -->
<td
  style="border-top-style: solid; border-bottom-style: solid; border-left-style: solid; border-right-style: solid;"
>
  テキスト
</td>

<!-- 削減後：罫線情報削除 -->
<td>テキスト</td>

<!-- 複雑な表の場合（保持）-->
<td style="border-top-style: solid; border-bottom-style: none;">テキスト</td>
```

**想定される効果:**

- LLMが表を読み取る際に、不要なスタイル情報で混乱しにくくなる
- Markdownファイルのサイズが削減される（特に大規模な法令）
- 表の論理構造により焦点が当たりやすくなる

#### ルビ（ふりがな）

```html
<ruby>漢字<rt>かんじ</rt></ruby>
```

#### 前文・附則

特別な構造要素として処理されます。

---

## 設定ファイル

### law_list.txt

一括処理用の法令リストファイルです。1行に1つの法令名を記載します。

**書式:**

```
# コメント行（無視されます）
; コメント行（無視されます）
法令名1
法令名2
法令名3
```

**例:**

```
# 基本六法
日本国憲法
刑法
民法
民事訴訟法
刑事訴訟法
商法

# 交通関連
道路交通法
道路交通法施行令
道路交通法施行規則
```

### style.css

Markdown表示用のCSSスタイルシートです。Markdownビューアや静的サイトジェネレータで使用できます。

**特徴:**

- ダークモード対応
- 階層ごとに色分けされた見出し
- HTMLテーブルのスタイル
- ルビ表示のサポート

**使用例（VSCode、Typoraなど）:**

MarkdownプレビューでCSSを読み込むように設定してください。

---

## トラブルシューティング

### Q: `ModuleNotFoundError: No module named 'requests'`

**A:** 必要なライブラリがインストールされていません。

```bash
python -m pip install requests
```

### Q: 法令が見つからない

**A:** 以下を確認してください：

- 法令名が正確か（正式名称を使用）
- ネットワーク接続が正常か
- e-Gov法令APIが稼働しているか

### Q: 出力ファイルが見つからない

**A:** `output_Markdown/` フォルダを確認してください。フォルダは自動的に作成されます。

### Q: XMLファイルの解析に失敗する

**A:** 以下を確認してください：

- XMLファイルが破損していないか
- e-Gov法令XML形式に準拠しているか（`XMLSchemaForJapaneseLaw_v3.xsd` 参照）

### Q: 表が正しく表示されない

**A:** HTMLテーブルに対応したMarkdownビューアを使用してください。または、`style.css` を読み込んで表示してください。

### Q: 表の行・列の結合（rowspan/colspan）が正しく表示されない

**A:** 以下を確認してください：

1. **Markdownビューアの対応**: GitHub、GitLab、Notionなど主要プラットフォームではHTMLテーブルの rowspan/colspan をサポートしています
2. **ブラウザ表示**: ブラウザで直接HTMLを開くと正しく表示されます
3. **複雑な表の場合**: 罫線が多く複雑な表では、ブラウザプレビューを推奨します

### Q: 表の罫線がLLMに正確に読み取られない

**A:** これは仕様です。法令XMLの多くの表は罫線（Border属性）で見た目を表現しており、LLMが論理構造を正確に判定することは難しい傾向があります。

**原因の詳細:**

1. **見た目優先設計**: e-Gov法令XMLは視覚的な見栄えを優先し、rowspan/colspanではなく罫線で表現
2. **複数の表現方法混在**: セマンティックなrowspanと見た目のBorder属性が共存
3. **情報の分散**: HTML の style属性が多く含まれて読み取り対象の情報が分散

**対策:**

1. **出力ファイルから罫線を削除してからLLMに処理させる**
   - 単純な表（全セル solid border）では、罫線情報が自動削減される計画があります
   - これにより、LLMが不要なスタイル情報で混乱しにくくなります

2. **元のXML構造を参照させる**
   - 重要な表については、元のXML要素の `rowspan` 属性を参考にしてください
   - LLMに「テーブル構造は XML のrowspan属性を参考」と明示してください

3. **構造を明示する補助テキストを追加**
   - 複雑な表の前後に「このセルは○○の子要素」などのメタデータを追加
   - LLMがセルの関係性を明確に理解できるようにする

4. **複雑な表を分割処理**
   - 複数セクションから成る表は、セクションごとに分けてから処理する
   - 行や列ごとに簡潔なテキスト説明を追加する

**参考:**

- 詳細は「テーブルの罫線（Border）について」セクションを参照
- トークン削減戦略は「表の罫線情報の最適化（トークン削減戦略）」セクションを参照

### Q: 過去の時点の法令が取得できない

**A:** `--asof` オプションで日付を指定してください。ただし、e-Gov APIで提供されている範囲内の日付である必要があります。

---

## モード1と モード2の比較表

| 項目                 | モード1（API）        | モード2（ローカル）       | モード3（リスト）                     |
| -------------------- | --------------------- | ------------------------- | ------------------------------------- |
| **入力方式**         | 法令名を入力          | ローカルXMLファイル       | 法令リストファイル                    |
| **処理対象**         | 単一法令              | 単一または複数XML         | 複数法令                              |
| **画像埋め込み**     | ✅ 自動取得・埋め込み | ❌ 取得しない             | ✅ 自動取得・埋め込み                 |
| **ファイル名形式**   | 法令名\_施行日.md     | 法令名.md                 | 法令名\_施行日.md                     |
| **上書き動作**       | 確認後に上書き        | 確認後に上書き            | **確認なしで自動上書き**              |
| **ネットワーク必須** | 必須                  | 不要                      | 必須                                  |
| **処理速度**         | 遅い（API呼び出し有） | 速い（ローカル処理）      | 中程度（件数にもよるがapi制限に注意） |
| **利用場面**         | 単発の変換            | ダウンロード済みXMLの処理 | **バッチ処理・自動化**                |

### モード1 と モード3 の選択ガイド

**モード1を選ぶべき場合:**

- 1～2個の法令を変換したい
- 既存ファイルに対して確認してから上書きしたい
- 対話的に法令を検索・選択したい

**モード3を選ぶべき場合:**

- 10個以上の法令を一度に変換したい
- バッチ処理・自動スクリプトとして使用したい
- 既存ファイルの上書きを確認なしで進めたい（前提：リストの内容が信頼できる）
- 定期的に同じセットの法令を更新したい

---

### モード3での注意事項

**⚠️ 自動上書き動作**

モード3では、既存ファイルに対して**確認なしで自動上書き**されます。これはバッチ処理での効率を優先しているためです。

- リストファイルに含まれるすべての法令が対象
- 既存ファイルはバックアップなしで上書き
- 重要なファイルの喪失を避けるため、事前にバックアップを推奨

**リストファイルの書き方**

```
# コメント行（# または ; で始まる行は無視される）
; このように書くこともできます

日本国憲法
刑法
民法
道路交通法
道路交通法施行令
道路交通法施行規則
# e-govにあれば政令も取得できます。
```

---

### 画像が埋め込まれない場合

**症状**: Markdownに`<img>`タグがあるが、画像ファイルが生成されていない

**原因の確認**:

1. **モード2を使用している**: ローカルXMLファイルには法令履歴IDが含まれていないため、画像APIを呼び出せません
2. **`--no-images` オプションを使用している**: 画像ダウンロードが明示的に無効になっています

**解決方法**:

- **推奨**: モード1（API取得）またはモード3（リストから一括処理）を使用してください
- **代替案**: モード2で取得したXMLから再度モード1で処理する

## ライセンス

このツールはオープンソースです。e-Gov法令APIの利用規約に従ってご使用ください。

### 開発記録

このプロジェクトの実装・改善履歴は `git commit` メッセージで詳細に記録されています。

```bash
# 開発履歴を確認
git log --oneline
```

主な commit 例：

- `fix(table): <thead>のrowspanをセマンティックHTML対応に修正`
- `build: 公開用ファイル整理`
- `docs: XML要素対応状況を2026-02-01版に更新`

---

## 参考リンク

- [e-Gov法令API](https://elaws.e-gov.go.jp/)
- [e-Gov法令XMLスキーマ](https://elaws.e-gov.go.jp/file/XMLSchemaForJapaneseLaw_v3.xsd)

---

## 更新履歴

### 2026-02-01

- **セマンティックHTML対応**: TableRow を `<tbody>` のみで処理
- **ファイル整理**: 公開用にテスト・デバッグファイルを削除
- **ドキュメント更新**: XML要素対応状況を98%に更新
- **README更新**: ペアプログラミングAI開発であることを明記

### 2026-01-31

- HTMLテーブル形式のサポート追加
- テーブル属性（rowspan、colspan、border、align、valignなど）の対応
- ルビのHTML形式出力に変更
- CSSスタイルの改善（ダークモード対応）

---

**Enjoy converting Japanese laws to Markdown! 📜→📝**
