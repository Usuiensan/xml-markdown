## 🛠️ 法令XML変換スクリプト：リファクタリング及び修正指示書

### 1. Markdown階層構造の再定義

法令の深い階層構造をMarkdownの6レベル制限に収め、かつPWAでの検索性を最大化するため、以下のマッピングを厳守すること。

| 法令構造            | Markdown記法            | 備考                                 |
| ------------------- | ----------------------- | ------------------------------------ |
| **編 (Part)**       | `#` (H1)                | 巨大な法令のみ                       |
| **章 (Chapter)**    | `##` (H2)               |                                      |
| **節 (Section)**    | `###` (H3)              |                                      |
| **款 (Subsection)** | `**第三款 〇〇**`       | 見出しレベルを消費しない（太字）     |
| **目 (Division)**   | `**第一目 〇〇**`       | 見出しレベルを消費しない（太字）     |
| **条 (Article)**    | `#### 第〇条（見出し）` | **固定アンカー**として扱う           |
| **項 (Paragraph)**  | `1. 2. 3.`              | (ここについてはプログラムの修正不要) |
| **号 (Item)**       | `- 一 二 三`            | (プログラムのここについては修正不要) |

---

### 2. グローバル変数の廃止と状態管理のリファクタリング

`CURRENT_LAW_REVISION_ID` および `CURRENT_IMAGE_DIR` による状態管理を廃止し、**依存性注入（引数による受け渡し）**へ移行する。

- **競合状態の解消**: マルチスレッド環境での安全性を確保するため、各関数に `law_revision_id` と `image_dir` を明示的に渡す。
- **初期化順序の修正**: `parse_to_markdown()` を呼び出す**前**に `image_dir` を確定させ、引数として注入すること。

```python
# リファクタリング後の理想的な流れ
def process_from_api(law_name, asof_date=None):
    xml_data, law_revision_id = fetch_law_data(law_name, asof_date)
    # 1. 変換前にディレクトリを決定
    image_dir = determine_image_dir(law_name, law_revision_id)

    # 2. 引数として状態を注入
    md_output = parse_to_markdown(
        xml_data,
        law_revision_id=law_revision_id,
        image_dir=image_dir
    )

```

---

### 3. 画像処理・API連携のバグ修正

- **HTMLテーブル内の画像表示**:
  `<table>` タグ内ではMarkdownの `![]()` はレンダリングされない。`process_table_column_content()` を経由する場合は、以下のHTML形式で出力すること。

  > `<img src="パス" alt="代替テキスト" />`

- **APIエンドポイントの修正**:
  添付ファイル取得用のURL構築を以下に修正する。
  > 正: `https://laws.e-gov.go.jp/api/2/attachment/{law_revision_id}`

---

### 4. 算式（ArithFormula）の正規化処理の修正

`ArithFormula` 要素に対して `normalize_text()` を適用すると、改行が失われ計算式が崩壊する。

- **修正内容**: 算式要素に対しては `normalize_text()` ではなく `extract_text()` を使用し、改行を保持すること。
- **出力形式**: 保持された改行を含めたまま、Markdownのコードブロック（または適切な数式ブロック）としてレンダリングされるようにすること。

---

## Copilotへの指示出し例

IDEのチャット欄に以下のように入力してください。

> `@workspace` この「法令XML変換スクリプト：リファクタリング及び修正指示書」の内容に従って、`xml-to-md.py`（該当ファイル名）を修正してください。特に、グローバル変数の削除と、HTMLテーブル内での画像タグ変換、およびMarkdown見出しレベルの再定義を重点的に行ってください。

---
