# テーブルスタイル最適化改善

**実装日**: 2026年1月31日  
**対応状況**: ✅ 完了

---

## 📋 改善内容

### ユーザーリクエスト

テーブル内のセルの `border-●●-style` 属性に対して、以下のルールを適用：

1. **テーブル内の全セルの border-style が `solid`** の場合
   - → スタイル指定を**一切しない**（出力を最小化）

2. **1セルでも `none` | `dotted` | `double` がある**場合
   - → そのテーブルの**全セルに対して** XML と全く同じようにスタイルを記載

---

## 🔧 実装詳細

### 1. ヘルパー関数追加：`_check_table_has_non_solid_border()`

```python
def _check_table_has_non_solid_border(table, header, body_rows):
    """✨ NEW: テーブル内に solid 以外の border-style があるかを確認

    Args:
        table: Table要素
        header: TableHeaderRow要素（None可）
        body_rows: TableRow要素のリスト

    Returns:
        bool: True = solid以外あり（スタイル指定必要）
              False = 全てsolid（スタイル指定不要）
    """
```

**処理内容**：

- ヘッダーセルの全 `Border*` 属性をチェック
- ボディセルの全 `Border*` 属性をチェック
- 1つでも "solid" 以外があれば `True` を返す
- すべて "solid" なら `False` を返す

---

### 2. `render_table()` 関数の改善

**変更前**：各セルごとに Border スタイルを無条件に出力

**変更後**：

```python
# テーブル処理の最初にフラグを立てる
has_non_solid_border = _check_table_has_non_solid_border(table, header, body_rows)

# ヘッダーセル処理時にフラグを使用
attrs = get_cell_attributes(header_col, "th", enable_border_style=has_non_solid_border)

# ボディセル処理時にフラグに基づいてスタイル出力を制御
if has_non_solid_border:
    # Border スタイルをCSSに変換して出力
    ...
# else: solid のみの場合はスタイル指定しない
```

---

### 3. `get_cell_attributes()` 関数の改善

**新規パラメータ追加**：

```python
def get_cell_attributes(cell, cell_type="td", rowspan_override=None,
                       enable_border_style=True):
    """
    enable_border_style: border-style をスタイル属性に含めるかどうか
    """
```

**処理ロジック**：

```python
if enable_border_style:
    # Border属性をCSS border-*-style に変換
    ...
# else: スタイル属性に border-style を追加しない
```

---

## 🎯 効果

### 出力ファイル サイズ削減

テーブルのスタイル指定が不要な場合（すべて solid）：

**改善前**（例）：

```html
<table>
  <tr>
    <td style="border-top-style: solid; border-bottom-style: solid">セルA</td>
    <td style="border-top-style: solid; border-bottom-style: solid">セルB</td>
  </tr>
  ...（各セルに同じスタイル）
</table>
```

**改善後**（全部 solid の場合）：

```html
<table>
  <tr>
    <td>セルA</td>
    <td>セルB</td>
  </tr>
  ...（スタイル指定なし）
</table>
```

→ **出力ファイル サイズ大幅削減**

---

## ✅ テスト結果

```bash
$ python xml-to-md.py --law 道路交通法 --asof 2025-06-01
[道路交通法] を検索中... (API v2)
条文データをダウンロード中 (時点: 2025-06-01)...
変換開始: 道路交通法
[保存完了] output_Markdown\道路交通法_20250601.md

✅ 実行成功
✅ 構文チェック: エラーなし
```

---

## 📝 コード変更サマリー

### 新規追加

- `_check_table_has_non_solid_border()` 関数

### 修正

- `render_table()` - テーブルスキャンと条件付き出力
- `get_cell_attributes()` - `enable_border_style` パラメータ追加

### 総変更行数

- 追加: 約30行
- 修正: 約15行

---

## 🚀 次のステップ（オプション）

今後の最適化候補：

- CSS にスタイルルール（`.solid { border-style: solid; }` など）を集約する
- クライアント側で JavaScript で solid スタイルを削除する

---

**すべて完了しました！** ✨
